<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tyzz.blog.dao.ArticleDao">

    <resultMap id="BaseResultMap" type="com.tyzz.blog.entity.pojo.Article">
        <!--@Table article-->
        <result property="articleId" column="article_id" jdbcType="INTEGER"/>
        <result property="articleName" column="article_name" jdbcType="VARCHAR"/>
        <result property="userId" column="user_id" jdbcType="INTEGER"/>
        <result property="content" column="content" jdbcType="VARCHAR"/>
        <result property="viewCount" column="view_count" jdbcType="INTEGER"/>
        <result property="like" column="like" jdbcType="INTEGER"/>
        <result property="state" column="state" jdbcType="BOOLEAN"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <select id="listPage" parameterType="com.tyzz.blog.entity.dto.ArticlePageDTO" resultMap="BaseResultMap">
        <choose>
            <when test="articlePageDTO.labelId != null">
                SELECT a.* FROM article a WHERE a.article_id IN (
                    SELECT al.article_id FROM article_label al WHERE al.label_id = #{articlePageDTO.labelId}
                ) and
            </when>
            <otherwise>
                SELECT a.* FROM article a where
            </otherwise>
        </choose>

        a.state = 1

        <choose>
            <when test="articlePageDTO.key == 1">
                and a.user_id = #{articlePageDTO.userId}
            </when>
            <when test="articlePageDTO.key == 2">
                and a.article_id IN (
                SELECT c.article_id FROM collection c WHERE c.user_id = #{articlePageDTO.userId} AND c.state = 1
                )
            </when>
            <when test="articlePageDTO.key == 3">
                and a.`article_id` IN (
                SELECT DISTINCT c.article_id FROM COMMENT c
                   WHERE c.user_id = #{articlePageDTO.userId} AND c.article_id IS NOT NULL AND c.state = 1
                )
            </when>
        </choose>

        <if test="articlePageDTO.searchValue != null and articlePageDTO.searchValue != ''">
            and a.article_name like concat('%',#{articlePageDTO.searchValue},'%')
        </if>
        <if test="articlePageDTO.categoryId != null">
            and a.category_id = #{articlePageDTO.categoryId}
        </if>
        ORDER BY
        <if test="articlePageDTO.underscoreSortColumn == 'create_time'">
            a.create_time
        </if>
        <if test="articlePageDTO.underscoreSortColumn == 'view_count'">
            a.view_count
        </if>
        DESC
    </select>

    <select id="hotList" resultMap="BaseResultMap">
        select * from article
        where state = 1
        order by view_count desc
        limit 10
    </select>
</mapper>